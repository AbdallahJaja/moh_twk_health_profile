<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MOH Vitals Mini App</title>
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Custom Styles -->
  <style>
    .shimmer-wrapper {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      height: 100px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1050;
    }
  </style>
  
  <!-- Google Maps API (async, defer) -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY"></script>
  
  <script src="twk_helper.js"></script>
  <script src="constants.js"></script>
  <script src="settings.js"></script>
  <script src="apis.js"></script>
</head>
<body>
  <div class="container my-3">
    <!-- User Header -->
    <div class="d-flex align-items-center mb-3">
      <img id="user-image" class="rounded-circle" width="50" height="50" alt="User Image">
      <div>
        <h4 id="greeting">Hi, Abdullah Jaja</h4>
        <p id="user-age" class="mb-0"></p>
      </div>
    </div>
    <!-- Search Box -->
    <input type="text" id="search" class="form-control mb-3" placeholder="Search vitals...">
    <!-- Loading Shimmer -->
    <div id="loading" class="shimmer-wrapper"></div>
    <!-- Vitals List -->
    <div id="vitals-list" class="list-group"></div>
    <!-- Digital Twin Section -->
    <div id="digital-twin" class="mt-4 p-3 border rounded">
      <h5>Digital Twin Insights</h5>
      <div id="twin-insights">Calculating insights...</div>
    </div>
  </div>
  
  <!-- Edit Modal (only value field) -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">Edit Value</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="edit-form">
            <input type="hidden" id="edit-metric-id">
            <div class="mb-3">
              <label for="edit-metric-value" class="form-label">Value</label>
              <input type="text" id="edit-metric-value" class="form-control">
            </div>
            <div id="edit-error" class="text-danger"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="save-edit-btn">Save</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Info Modal -->
  <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="infoModalLabel">Vital Information</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="infoModalBody">
          <!-- Description content goes here -->
        </div>
        <div class="modal-footer">
          <button id="moreInfoBtn" class="btn btn-link btn-sm">More Info</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Google Maps Modal -->
  <div class="modal fade" id="mapModal" tabindex="-1" aria-labelledby="mapModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="mapModalLabel">Location</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="map" style="height: 400px;"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Toast Notification for Copy -->
  <div class="toast-container">
    <div id="copyToast" class="toast align-items-center" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-body">Copied to clipboard!</div>
    </div>
  </div>
  
  <!-- Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const vitalsListEl = document.getElementById("vitals-list");
      const loadingEl = document.getElementById("loading");
      const searchEl = document.getElementById("search");
      
      async function loadVitals() {
        loadingEl.style.display = "block";
        try {
          const data = await fetchVitals();
          document.getElementById("user-image").src = data.user.image;
          document.getElementById("greeting").textContent = 
            `${AppSettings.language === "ar" ? LANG_AR.greeting : LANG_EN.greeting}, ${data.user.name}`;
          if (AppSettings.age !== null) {
            document.getElementById("user-age").textContent = `Age: ${AppSettings.age}`;
          }
          renderVitals(data.vitals);
          calculateDigitalTwin(data.vitals);
        } catch (error) {
          console.error("Error loading vitals", error);
        } finally {
          loadingEl.style.display = "none";
        }
      }
      
      function renderVitals(vitals) {
        vitalsListEl.innerHTML = "";
        vitals.forEach((vital) => {
          const vitalName = VITALS_TRANSLATION[vital.vital_key]?.[AppSettings.language] || vital.vital_key;
          const item = document.createElement("div");
          item.className = "list-group-item d-flex justify-content-between align-items-center";
          
          let vitalText = document.createElement("span");
          if (vital.type === "list") {
            vitalText.textContent = `${vitalName}: ${vital.value.join(", ")}`;
          } else if (vital.type === "location") {
            vitalText.innerHTML = `${vitalName}: ${vital.value} 
              <button class="btn btn-sm btn-outline-primary" onclick="showMap(${vital.coordinates.lat}, ${vital.coordinates.lng})">üìç View Map</button>`;
          } else {
            vitalText.textContent = `${vitalName}: ${vital.value} ${vital.unit || ""}`;
          }
          
          const btnContainer = document.createElement("div");
          
          // Info Button
          const infoBtn = document.createElement("button");
          infoBtn.className = "btn btn-info btn-sm mx-1";
          infoBtn.textContent = "i";
          infoBtn.onclick = () => showInfo(vital);
          
          // Copy Button
          const copyBtn = document.createElement("button");
          copyBtn.className = "btn btn-secondary btn-sm mx-1";
          copyBtn.textContent = AppSettings.language === "ar" ? "ŸÜÿ≥ÿÆ" : "Copy";
          copyBtn.onclick = () => copyToClipboard(vitalName, vital.value, vital.unit);
          
          btnContainer.append(infoBtn, copyBtn);
          
          // Edit Button (Only for items 1-13)
          if (vital.id >= 1 && vital.id <= 13) {
            const editBtn = document.createElement("button");
            editBtn.className = "btn btn-primary btn-sm mx-1";
            editBtn.textContent = "Edit";
            editBtn.onclick = () => openEditModal(vital);
            btnContainer.appendChild(editBtn);
          }
          
          // Conversion Button for numeric values (kg or cm)
          if (vital.type === "numeric" && vital.unit && (vital.unit === "kg" || vital.unit === "cm")) {
            const convertBtn = document.createElement("button");
            convertBtn.className = "btn btn-warning btn-sm mx-1";
            convertBtn.textContent = LANG_EN.convertUnits;
            convertBtn.onclick = () => toggleConversion(vital, convertBtn);
            btnContainer.appendChild(convertBtn);
          }
          
          // More Info button using TWK.openUrl
          if (vital.more_info) {
            const moreInfoBtn = document.createElement("button");
            moreInfoBtn.className = "btn btn-link btn-sm mx-1";
            moreInfoBtn.textContent = LANG_EN.moreInfo;
            moreInfoBtn.onclick = () => TWK.openUrl(vital.more_info, 1);
            btnContainer.appendChild(moreInfoBtn);
          }
          
          item.append(vitalText, btnContainer);
          vitalsListEl.appendChild(item);
        });
      }
      
      // Opens the edit modal with the selected vital's value
      function openEditModal(vital) {
        document.getElementById("edit-metric-id").value = vital.id;
        document.getElementById("edit-metric-value").value = vital.value;
        document.getElementById("edit-error").textContent = "";
        new bootstrap.Modal(document.getElementById("editModal")).show();
      }
      
      // Show info modal with vital description
      function showInfo(vital) {
        document.getElementById("infoModalBody").textContent = vital.description || "No description available.";
        new bootstrap.Modal(document.getElementById("infoModal")).show();
      }
      
      // Copy to clipboard and show toast notification
      function copyToClipboard(name, value, unit) {
        let text = `${name}: `;
        if (Array.isArray(value)) {
          text += value.join(", ");
        } else {
          text += value;
        }
        if (unit) text += ` ${unit}`;
        navigator.clipboard.writeText(text)
          .then(() => {
            const toastEl = document.getElementById("copyToast");
            new bootstrap.Toast(toastEl).show();
          })
          .catch(err => console.error("Copy failed", err));
      }
      
      // Toggle unit conversion and update the vital display
      function toggleConversion(vital, btn) {
        // We'll use a custom property "converted" to toggle state
        if (!vital.converted) {
          if (vital.unit === "kg") {
            vital.convertedValue = (vital.value * 2.20462).toFixed(2);
            vital.convertedUnit = "lbs";
          } else if (vital.unit === "cm") {
            vital.convertedValue = (vital.value * 0.393701).toFixed(2);
            vital.convertedUnit = "inches";
          }
          vital.converted = true;
          btn.textContent = "Show Original";
        } else {
          vital.converted = false;
          btn.textContent = LANG_EN.convertUnits;
        }
        // Refresh the vitals list to show updated conversion for this vital.
        updateVitalDisplay(vital);
      }
      
      function updateVitalDisplay(vital) {
        // Re-render only the changed vital (for simplicity, reload all)
        loadVitals();
      }
      
      // Show Google Map in modal for location vitals
      window.showMap = function(lat, lng) {
        const mapModal = new bootstrap.Modal(document.getElementById("mapModal"));
        mapModal.show();
        setTimeout(() => {
          const map = new google.maps.Map(document.getElementById("map"), {
            center: { lat, lng },
            zoom: 14
          });
          new google.maps.Marker({ position: { lat, lng }, map });
        }, 500);
      };
      
      // Save edited vital value
      document.getElementById("save-edit-btn").addEventListener("click", async function() {
        const id = document.getElementById("edit-metric-id").value;
        const newValue = document.getElementById("edit-metric-value").value.trim();
        if (newValue === "") {
          document.getElementById("edit-error").textContent = "Invalid value.";
          return;
        }
        const success = await saveVital(id, newValue);
        if (success) {
          new bootstrap.Modal(document.getElementById("editModal")).hide();
          loadVitals();
        } else {
          document.getElementById("edit-error").textContent = "Save failed. Please try again.";
        }
      });
      
      // Local search functionality
      searchEl.addEventListener("input", function() {
        const filter = searchEl.value.toLowerCase();
        document.querySelectorAll(".list-group-item").forEach(item => {
          item.style.display = item.textContent.toLowerCase().includes(filter) ? "" : "none";
        });
      });
      
      // Digital Twin: simple longevity insights based on BMI
      function calculateDigitalTwin(vitals) {
        let bmiRecord = vitals.find(v => v.vital_key === "bmi");
        let insight = "Maintain a healthy lifestyle for longevity.";
        if (bmiRecord) {
          let currentBMI = vitalConvertForDisplay(bmiRecord);
          if (currentBMI >= 18.5 && currentBMI <= 24.9) {
            insight = "Your BMI is optimal. Keep up the good work for a long life!";
          } else {
            insight = "Consider lifestyle changes to improve your longevity prospects.";
          }
        }
        document.getElementById("twin-insights").textContent = insight;
      }
      
      // Helper: If a vital is converted, return converted value; otherwise, original
      function vitalConvertForDisplay(vital) {
        if (vital.converted) {
          return vital.convertedValue;
        }
        return vital.value;
      }
      
      async function loadVitals() {
        loadingEl.style.display = "block";
        try {
          const data = await fetchVitals();
          document.getElementById("user-image").src = data.user.image;
          document.getElementById("greeting").textContent = 
            `${AppSettings.language === "ar" ? LANG_AR.greeting : LANG_EN.greeting}, ${data.user.name}`;
          if (AppSettings.age !== null) {
            document.getElementById("user-age").textContent = `Age: ${AppSettings.age}`;
          }
          renderVitals(data.vitals);
          calculateDigitalTwin(data.vitals);
        } catch (error) {
          console.error("Error loading vitals", error);
        } finally {
          loadingEl.style.display = "none";
        }
      }
      
      loadVitals();
    });
  </script>
</body>
</html>